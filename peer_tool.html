<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peer Finding Tool | Firm Benchmarking</title>
    
    <!-- Using Tailwind CSS to match your main website -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- PapaParse for CSV processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            color: #334155; /* slate-700 */
        }
        
        /* Custom Scrollbar for dropdown */
        .suggestions-list::-webkit-scrollbar {
            width: 8px;
        }
        .suggestions-list::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .suggestions-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .suggestions-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navigation (Matches your Index page) -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="index.html" class="flex-shrink-0 flex items-center">
                        <span class="text-xl font-bold text-slate-800 tracking-tight">Firm<span class="text-blue-600">Benchmarking</span></span>
                    </a>
                </div>
                <div class="flex items-center">
                    <a href="index.html" class="text-sm font-medium text-slate-600 hover:text-blue-600 transition-colors">
                        &larr; Back to Home
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        
        <div class="text-center mb-12">
            <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 mb-4">
                Peer Finding Tools
            </h1>
            <p class="text-lg text-slate-600 max-w-2xl mx-auto">
                Search for a company below to view its top 10 comparable firms. 
                Use the <strong>US</strong> tool for domestic peers (FSB) or the <strong>Global</strong> tool for international peers (IFSB).
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-7xl mx-auto">
            
            <!-- ========================================== -->
            <!-- DOMESTIC PEERS SECTION (FSB)               -->
            <!-- ========================================== -->
            <div class="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">
                <div class="p-6 bg-slate-50 border-b border-slate-100">
                    <h2 class="text-2xl font-bold text-slate-800 flex items-center">
                        <span class="bg-blue-100 text-blue-700 p-2 rounded-lg mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                            </svg>
                        </span>
                        Find Peers for US firms
                    </h2>
                    <p class="text-sm text-slate-500 mt-2 ml-1">Based on FSB Data</p>
                </div>

                <div class="p-6">
                    <!-- Search Input -->
                    <div class="relative mb-6">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <input type="text" id="domesticInput" 
                            class="block w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none disabled:opacity-60 disabled:cursor-not-allowed" 
                            placeholder="Type US company name..." 
                            autocomplete="off" 
                            disabled>
                        
                        <!-- Suggestions Dropdown -->
                        <div id="domesticSuggestions" class="suggestions-list absolute w-full bg-white mt-1 rounded-lg shadow-xl border border-slate-100 max-h-60 overflow-y-auto hidden z-50"></div>
                    </div>

                    <!-- Status Messages -->
                    <div id="domesticLoading" class="flex items-center justify-center text-slate-500 text-sm py-4">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Loading fsb.csv...
                    </div>
                    
                    <div id="domesticError" class="hidden p-3 bg-red-50 text-red-700 text-sm rounded-lg text-center mb-4"></div>

                    <!-- Manual Upload Fallback -->
                    <div id="domesticManualLoad" class="hidden p-4 bg-amber-50 border border-amber-200 rounded-lg mb-4">
                        <p class="text-amber-800 text-xs font-medium mb-2 text-center">Auto-load failed. Select 'fsb.csv':</p>
                        <input type="file" id="domesticFileInput" accept=".csv" class="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    </div>

                    <!-- Results Table -->
                    <div id="domesticResults" class="hidden">
                        <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-3">
                            Peers for: <span id="domesticSelectedName" class="text-blue-700"></span>
                        </h3>
                        <div class="overflow-x-auto border rounded-lg border-slate-200">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 text-slate-600 text-xs uppercase">
                                    <tr>
                                        <th class="p-3 font-semibold border-b border-slate-200 text-center w-12">Rank</th>
                                        <th class="p-3 font-semibold border-b border-slate-200">Peer Company</th>
                                        <th class="p-3 font-semibold border-b border-slate-200 text-right">FSB</th>
                                    </tr>
                                </thead>
                                <tbody id="domesticTableBody" class="divide-y divide-slate-100 text-sm text-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================================== -->
            <!-- GLOBAL PEERS SECTION (IFSB)                -->
            <!-- ========================================== -->
            <div class="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">
                <div class="p-6 bg-slate-50 border-b border-slate-100">
                    <h2 class="text-2xl font-bold text-slate-800 flex items-center">
                        <span class="bg-indigo-100 text-indigo-700 p-2 rounded-lg mr-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </span>
                        Find Peers for Global firms
                    </h2>
                    <p class="text-sm text-slate-500 mt-2 ml-1">Based on IFSB Data</p>
                </div>

                <div class="p-6">
                    <!-- Search Input -->
                    <div class="relative mb-6">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <input type="text" id="globalInput" 
                            class="block w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all outline-none disabled:opacity-60 disabled:cursor-not-allowed" 
                            placeholder="Type global company name..." 
                            autocomplete="off" 
                            disabled>
                        
                        <!-- Suggestions Dropdown -->
                        <div id="globalSuggestions" class="suggestions-list absolute w-full bg-white mt-1 rounded-lg shadow-xl border border-slate-100 max-h-60 overflow-y-auto hidden z-50"></div>
                    </div>

                    <!-- Status Messages -->
                    <div id="globalLoading" class="flex items-center justify-center text-slate-500 text-sm py-4">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Loading ifsb.csv...
                    </div>
                    
                    <div id="globalError" class="hidden p-3 bg-red-50 text-red-700 text-sm rounded-lg text-center mb-4"></div>

                    <!-- Manual Upload Fallback -->
                    <div id="globalManualLoad" class="hidden p-4 bg-amber-50 border border-amber-200 rounded-lg mb-4">
                        <p class="text-amber-800 text-xs font-medium mb-2 text-center">Auto-load failed. Select 'ifsb.csv':</p>
                        <input type="file" id="globalFileInput" accept=".csv" class="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                    </div>

                    <!-- Results Table -->
                    <div id="globalResults" class="hidden">
                        <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-3">
                            Peers for: <span id="globalSelectedName" class="text-indigo-700"></span>
                        </h3>
                        <div class="overflow-x-auto border rounded-lg border-slate-200">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 text-slate-600 text-xs uppercase">
                                    <tr>
                                        <th class="p-3 font-semibold border-b border-slate-200 text-center w-12">Rank</th>
                                        <th class="p-3 font-semibold border-b border-slate-200">Peer Company</th>
                                        <th class="p-3 font-semibold border-b border-slate-200 text-center">Country</th>
                                        <th class="p-3 font-semibold border-b border-slate-200 text-right">IFSB</th>
                                    </tr>
                                </thead>
                                <tbody id="globalTableBody" class="divide-y divide-slate-100 text-sm text-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 mt-auto">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-slate-400 text-sm">
                &copy; <script>document.write(new Date().getFullYear())</script> Firm Benchmarking. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- Logic -->
    <script>
        // Store Datasets
        const domesticData = { firms: {}, names: [] };
        const globalData = { firms: {}, names: [] };

        // --- 1. DOMESTIC LOGIC (FSB) ---
        const domesticInput = document.getElementById('domesticInput');
        const domesticSuggestions = document.getElementById('domesticSuggestions');
        const domesticResults = document.getElementById('domesticResults');
        
        initDataLoad('fsb.csv', 'domestic');

        // --- 2. GLOBAL LOGIC (IFSB) ---
        const globalInput = document.getElementById('globalInput');
        const globalSuggestions = document.getElementById('globalSuggestions');
        const globalResults = document.getElementById('globalResults');
        
        initDataLoad('ifsb.csv', 'global');


        // --- GENERIC LOADING FUNCTION ---
        async function initDataLoad(filename, type) {
            const loadingEl = document.getElementById(`${type}Loading`);
            const manualEl = document.getElementById(`${type}ManualLoad`);
            const fileInput = document.getElementById(`${type}FileInput`);

            try {
                const response = await fetch(`./${filename}`);
                if (!response.ok) throw new Error("Fetch failed");
                const csvText = await response.text();
                if (csvText.trim().startsWith('<')) throw new Error("Invalid CSV"); // Check for HTML response
                
                parseCSV(csvText, type);
            } catch (err) {
                console.warn(`${filename} auto-load failed.`, err);
                loadingEl.style.display = 'none';
                manualEl.classList.remove('hidden');
            }

            // Bind manual upload listener
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    loadingEl.style.display = 'flex';
                    loadingEl.textContent = "Parsing...";
                    manualEl.classList.add('hidden');
                    
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            processData(results.data, type);
                        },
                        error: function() {
                            loadingEl.style.display = 'none';
                            document.getElementById(`${type}Error`).textContent = "Error parsing file.";
                            document.getElementById(`${type}Error`).classList.remove('hidden');
                        }
                    });
                }
            });
        }

        function parseCSV(csvText, type) {
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processData(results.data, type);
                },
                error: function() {
                    document.getElementById(`${type}Loading`).style.display = 'none';
                    document.getElementById(`${type}ManualLoad`).classList.remove('hidden');
                }
            });
        }

        function processData(data, type) {
            const target = (type === 'domestic') ? domesticData : globalData;
            
            // Reset
            target.firms = {};
            target.names = [];

            data.forEach(row => {
                const company = row.conm;
                const peer = row.conm_peers;
                
                if (company && peer) {
                    if (!target.firms[company]) {
                        target.firms[company] = [];
                    }

                    if (type === 'domestic') {
                        // FSB Data Structure
                        target.firms[company].push({
                            peer: peer,
                            rank: parseInt(row.fsbrank),
                            score: parseFloat(row.fsb)
                        });
                    } else {
                        // IFSB Data Structure
                        target.firms[company].push({
                            peer: peer,
                            rank: parseInt(row.ifsbrank),
                            score: parseFloat(row.ifsb),
                            country: row.loc_peers // Changed from row.loc to row.loc_peers
                        });
                    }
                }
            });

            target.names = Object.keys(target.firms).sort();
            
            // Enable UI
            document.getElementById(`${type}Loading`).style.display = 'none';
            const input = document.getElementById(`${type}Input`);
            input.disabled = false;
            
            console.log(`Loaded ${target.names.length} ${type} companies.`);
            
            // Bind Search Listeners
            bindSearch(type);
        }

        function bindSearch(type) {
            const input = document.getElementById(`${type}Input`);
            const list = document.getElementById(`${type}Suggestions`);
            const dataObj = (type === 'domestic') ? domesticData : globalData;

            input.addEventListener('keyup', function() {
                const query = this.value.toUpperCase();
                list.innerHTML = '';
                
                if (query.length < 2) {
                    list.classList.add('hidden');
                    return;
                }

                const matches = dataObj.names.filter(name => name.includes(query)).slice(0, 10);

                if (matches.length > 0) {
                    matches.forEach(match => {
                        const div = document.createElement('div');
                        div.className = 'p-3 hover:bg-slate-50 cursor-pointer text-slate-700 transition-colors border-b border-slate-50 last:border-0 text-sm';
                        div.textContent = match;
                        div.addEventListener('click', () => {
                            selectCompany(match, type);
                        });
                        list.appendChild(div);
                    });
                    list.classList.remove('hidden');
                } else {
                    list.classList.add('hidden');
                }
            });

            // Close dropdown on outside click
            document.addEventListener('click', function(e) {
                if (e.target !== input && e.target !== list) {
                    list.classList.add('hidden');
                }
            });
        }

        function selectCompany(name, type) {
            const input = document.getElementById(`${type}Input`);
            const list = document.getElementById(`${type}Suggestions`);
            const resultsDiv = document.getElementById(`${type}Results`);
            const nameSpan = document.getElementById(`${type}SelectedName`);
            const tbody = document.getElementById(`${type}TableBody`);
            const dataObj = (type === 'domestic') ? domesticData : globalData;

            input.value = name;
            list.classList.add('hidden');
            nameSpan.textContent = name;

            const peers = dataObj.firms[name] || [];
            peers.sort((a, b) => a.rank - b.rank);

            tbody.innerHTML = '';
            
            if (peers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-slate-500 italic">No peers found.</td></tr>`;
            } else {
                peers.slice(0, 10).forEach(p => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition-colors";
                    const scoreDisplay = typeof p.score === 'number' ? p.score.toFixed(3) : p.score;
                    
                    if (type === 'domestic') {
                        tr.innerHTML = `
                            <td class="p-3 text-center"><span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-200 text-slate-700 font-bold text-xs">${p.rank}</span></td>
                            <td class="p-3 font-medium text-slate-800">${p.peer}</td>
                            <td class="p-3 text-right font-mono text-blue-600 font-medium">${scoreDisplay}</td>
                        `;
                    } else {
                        // Global columns: Rank | Peer | Country (loc_peers) | IFSB
                        tr.innerHTML = `
                            <td class="p-3 text-center"><span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-indigo-100 text-indigo-700 font-bold text-xs">${p.rank}</span></td>
                            <td class="p-3 font-medium text-slate-800">${p.peer}</td>
                            <td class="p-3 text-center font-medium text-slate-500">${p.country}</td>
                            <td class="p-3 text-right font-mono text-indigo-600 font-medium">${scoreDisplay}</td>
                        `;
                    }
                    tbody.appendChild(tr);
                });
            }

            resultsDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>
